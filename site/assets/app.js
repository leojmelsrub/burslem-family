(() => {const menu = document.querySelector('[data-menu]'); const toggle = document.querySelector('[data-menu-toggle]'); const scrim = document.querySelector('[data-menu-scrim]'); const closeBtn = document.querySelector('[data-menu-close]'); const body = document.body; const nav = document.querySelector('.nav'); let lastFocus = null; const focusableSelectors = 'a[href], button:not([disabled]), textarea, input, select, summary, [tabindex]:not([tabindex="-1"])'; const getFocusable = () => (menu ? Array.from(menu.querySelectorAll(focusableSelectors)).filter(el => !el.hasAttribute('disabled')) : []); const trapFocus = (e) => {if (!menu || !menu.classList.contains('open') || e.key !== 'Tab') return; const focusable = getFocusable(); if (!focusable.length) return; const first = focusable[0]; const last = focusable[focusable.length - 1]; if (e.shiftKey && document.activeElement === first) {e.preventDefault(); last.focus();} else if (!e.shiftKey && document.activeElement === last) {e.preventDefault(); first.focus();}}; const closeMenu = () => {if (!menu) return; menu.classList.remove('open'); if (scrim) scrim.classList.remove('open'); if (toggle) toggle.setAttribute('aria-expanded', 'false'); body.classList.remove('nav-open'); if (lastFocus) lastFocus.focus(); lastFocus = null;}; const openMenu = () => {if (!menu) return; lastFocus = document.activeElement; menu.classList.add('open'); if (scrim) scrim.classList.add('open'); if (toggle) toggle.setAttribute('aria-expanded', 'true'); body.classList.add('nav-open'); const focusable = getFocusable(); if (focusable.length) focusable[0].focus();}; if (toggle && menu) {toggle.addEventListener('click', () => {const isOpen = menu.classList.contains('open'); if (isOpen) closeMenu(); else openMenu();});} if (closeBtn) closeBtn.addEventListener('click', closeMenu); if (scrim) {scrim.addEventListener('click', closeMenu);} if (menu) {let startX = 0; let startY = 0; let tracking = false; menu.addEventListener('touchstart', (e) => {if (!menu.classList.contains('open')) return; const t = e.touches[0]; startX = t.clientX; startY = t.clientY; tracking = true;}, {passive: true}); menu.addEventListener('touchmove', (e) => {if (!tracking) return; const t = e.touches[0]; const dx = t.clientX - startX; const dy = t.clientY - startY; if (dx < -60 && Math.abs(dy) < 50) {tracking = false; closeMenu();}}, {passive: true}); menu.addEventListener('touchend', () => {tracking = false;}, {passive: true});} document.addEventListener('keydown', (e) => {if (e.key === 'Escape') closeMenu(); trapFocus(e);}); document.addEventListener('click', (e) => {const a = e.target.closest('a'); if (a && menu && menu.classList.contains('open')) {closeMenu();}}); const currentPath = window.location.pathname.replace(/\/index\.html$/, '/'); document.querySelectorAll('.menu a').forEach((link) => {const href = link.getAttribute('href'); if (!href) return; const normalized = href.replace(/\/index\.html$/, '/'); if (normalized === currentPath) {if (href === '/index.html' || currentPath === '/') return; link.classList.add('is-active');}}); const main = document.querySelector('main'); if (main) {main.classList.add('fade-enter'); requestAnimationFrame(() => {main.classList.add('fade-enter-active');});} const article = document.querySelector('.bio-theme'); if (article) {if (!document.querySelector('.reading-progress')) {const progress = document.createElement('div'); progress.className = 'reading-progress'; progress.innerHTML = '<div class="bar"></div>'; document.body.appendChild(progress);} if (!document.querySelector('.back-to-top')) {const back = document.createElement('button'); back.className = 'back-to-top'; back.type = 'button'; back.textContent = 'Back to top'; back.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'})); document.body.appendChild(back);}} const updateReadingUI = () => {const bar = document.querySelector('.reading-progress .bar'); const back = document.querySelector('.back-to-top'); if (bar) {const total = document.documentElement.scrollHeight - window.innerHeight; const pct = total > 0 ? (window.scrollY / total) * 100 : 0; bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;} if (back) {if (window.scrollY > 520) back.classList.add('show'); else back.classList.remove('show');}}; if (article) {window.addEventListener('scroll', updateReadingUI, {passive: true}); window.addEventListener('resize', updateReadingUI); updateReadingUI();} if (article && !article.querySelector('.toc')) {const headings = Array.from(article.querySelectorAll('h2[id]')); if (headings.length >= 3) {const toc = document.createElement('nav'); toc.className = 'toc'; const list = document.createElement('ul'); headings.forEach((h) => {const li = document.createElement('li'); const a = document.createElement('a'); a.href = `#${h.id}`; a.textContent = h.textContent.trim(); li.appendChild(a); list.appendChild(li);}); toc.innerHTML = '<h2>On this page</h2>'; toc.appendChild(list); const header = article.querySelector('.bio-header'); if (header && header.nextSibling) {header.parentNode.insertBefore(toc, header.nextSibling);} else {article.prepend(toc);}}} const observeToc = () => {const toc = document.querySelector('.toc'); if (!toc) return; const links = Array.from(toc.querySelectorAll('a')); const map = new Map(); links.forEach((link) => {const id = link.getAttribute('href').replace('#', ''); const target = document.getElementById(id); if (target) map.set(target, link);}); const observer = new IntersectionObserver((entries) => {entries.forEach((entry) => {const link = map.get(entry.target); if (!link) return; if (entry.isIntersecting) {links.forEach((l) => l.classList.remove('is-active')); link.classList.add('is-active');}});}, {rootMargin: '-20% 0px -70% 0px', threshold: 0.1}); map.forEach((_, target) => observer.observe(target));}; const searchInput = document.querySelector('.search-input'); const postList = document.querySelector('[data-post-list]'); const updateGroupVisibility = () => {if (!postList) return; postList.querySelectorAll('.century-group').forEach((section) => {const cards = Array.from(section.querySelectorAll('.post-card')); const visible = cards.some((card) => card.style.display !== 'none'); section.style.display = visible ? '' : 'none';});}; const filterPosts = (query) => {if (!postList) return; const q = query.trim().toLowerCase(); postList.querySelectorAll('.post-card').forEach((card) => {const text = card.textContent.toLowerCase(); card.style.display = q === '' || text.includes(q) ? '' : 'none';}); updateGroupVisibility();}; if (searchInput) {const params = new URLSearchParams(window.location.search); const preset = params.get('q') || ''; if (preset) {searchInput.value = preset; filterPosts(preset);} searchInput.addEventListener('input', (e) => {filterPosts(e.target.value);}); searchInput.addEventListener('keydown', (e) => {if (e.key === 'Enter' && !postList) {const q = e.target.value.trim(); if (q) window.location.href = `/index.html?q=${encodeURIComponent(q)}`;}});} const buildCenturyGroups = () => {if (!postList || postList.dataset.grouped === 'true') return; const cards = Array.from(postList.querySelectorAll('.post-card')); if (!cards.length) return; const groups = {}; const order = []; cards.forEach((card) => {const century = card.getAttribute('data-century') || 'Other'; if (!groups[century]) {groups[century] = []; order.push(century);} groups[century].push(card);}); postList.innerHTML = ''; order.forEach((century) => {const section = document.createElement('section'); section.className = 'century-group'; section.dataset.centuryGroup = century; section.id = `century-${century}`; const title = document.createElement('h2'); title.className = 'century-title'; title.textContent = century; const container = document.createElement('div'); container.className = 'post-list-group'; groups[century].forEach((card) => container.appendChild(card)); section.appendChild(title); section.appendChild(container); postList.appendChild(section);}); postList.dataset.grouped = 'true'; const mainEl = document.querySelector('main'); if (mainEl && !document.querySelector('#top')) {const top = document.createElement('div'); top.id = 'top'; mainEl.prepend(top);}}; buildCenturyGroups(); observeToc(); const track = document.querySelector('.timeline-track'); const list = document.querySelector('[data-post-list]'); if (track && list) {track.addEventListener('click', (e) => {const btn = e.target.closest('.timeline-chip'); if (!btn) return; const century = btn.getAttribute('data-century'); track.querySelectorAll('.timeline-chip').forEach((b) => b.classList.remove('is-active')); btn.classList.add('is-active'); const cards = list.querySelectorAll('.post-card'); cards.forEach((card) => {const c = card.getAttribute('data-century'); if (century === 'all' || c === century) {card.style.display = '';} else {card.style.display = 'none';}}); updateGroupVisibility();});} document.addEventListener('click', (e) => {if (e.defaultPrevented) return; if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return; const a = e.target.closest('a'); if (!a) return; if (a.target && a.target !== '_self') return; if (a.hasAttribute('download')) return; const href = a.getAttribute('href') || ''; if (href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('#')) return; if (!href.endsWith('.html')) return; e.preventDefault(); if (main) {main.classList.add('fade-exit-active'); setTimeout(() => {window.location.href = href;}, 160);} else {window.location.href = href;}}); const updateNav = () => {if (!nav) return; const scrolled = window.scrollY > 8; nav.classList.toggle('scrolled', scrolled); body.classList.toggle('nav-compact', window.scrollY > 120);}; updateNav(); window.addEventListener('scroll', updateNav, {passive: true}); if ('serviceWorker' in navigator) {window.addEventListener('load', () => {navigator.serviceWorker.register('/sw.js');});}})();